# generated by deplo CLI https://github.com/suntomi/deplo don't edit by hand.
name: Deplo CI/CD

on: 
  push:
    branches: ["main"]
  
  pull_request:
    branches: ["main"]
  repository_dispatch:
    types: [deplo-run-remote-job]

env:
  DEPLO_GHACTION_CI_ID: ${{ github.run_id }}-${{ github.run_attempt }}
  DEPLO_GHACTION_PR_URL: ${{ github.event.pull_request.url }}
  DEPLO_GHACTION_EVENT_TYPE: ${{ github.event.action }}
  DEPLO_GHACTION_EVENT_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
  DEPLO_OVERWRITE_COMMIT: ${{ github.event.client_payload.commit }}
  DEPLO_OVERWRITE_RELEASE_TARGET: ${{ github.event.client_payload.release_target }}
  DEPLO_OVERWRITE_VERBOSITY: ${{ github.event.client_payload.verbosity }}
  DEPLO_OVERWRITE_WORKFLOW: ${{ github.event.client_payload.workflow }}
  SUNTOMI_VCS_ACCOUNT: ${{ secrets.SUNTOMI_VCS_ACCOUNT }}
  SUNTOMI_VCS_ACCOUNT_EMAIL: ${{ secrets.SUNTOMI_VCS_ACCOUNT_EMAIL }}
  SUNTOMI_VCS_ACCOUNT_KEY: ${{ secrets.SUNTOMI_VCS_ACCOUNT_KEY }}
jobs:
  deplo-main:
    name: Start CI ${{ github.event.client_payload.job_id }}
    runs-on: ubuntu-latest
    outputs:
      deploy-aws: ${{ steps.deplo-ci-kick.outputs.deploy-aws }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.2.2/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
      - name: Start deplo
        id: deplo-ci-kick
        run: deplo ci kick
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: umegaya/action-tmate@a3d459813f3429bd95fc48bcd980b2fb40f10ad0
        with:
          sudo: true
  deplo-finish:
    name: Cleanup CI
    if: ${{ !failure() && (needs.deploy-aws.outputs.need-cleanup) }}
    needs: ["deplo-main","deploy-aws"]
    runs-on: ubuntu-latest
    env:
      DEPLO_JOB_SYSTEM_OUTPUT_DEPLOY_AWS: ${{ needs.deploy-aws.outputs.system }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.2.2/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          lfs: false
          ref: ${{ github.event.client_payload.commit }}
      - name: Cleanup deplo
        id: deplo-ci-fin
        run: deplo ci fin

  deploy-aws:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.deploy-aws && !failure() }}
    name: Running job deploy-aws
    runs-on: ubuntu-latest
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-deploy-aws.outputs.need-cleanup }}
      system: ${{ steps.deplo-deploy-aws.outputs.system }}
      user: ${{ steps.deplo-deploy-aws.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.2.2/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: deploy aws
        id: deplo-deploy-aws
        run: deplo ci deploy aws
  