# generated by deplo CLI https://github.com/suntomi/deplo don't edit by hand.
name: Deplo Workflow Runner

on: 
  push:
    branches: ["main"]
  
  pull_request:
    branches: ["main"]
  repository_dispatch:
    types: [deplo-run-remote-job,deplo-send-module-payload]
  
  

env:
  DEPLO_GHACTION_CI_ID: ${{ github.run_id }}-${{ github.run_attempt }}
  DEPLO_GHACTION_EVENT_DATA: ${{ toJson(github) }}
  DEPLO_GHACTION_WORKFLOW_NAME: ${{ github.workflow }}
  DEPLO_OVERWRITE_VERBOSITY: ${{ github.event.client_payload.exec.verbosity }}
  SUNTOMI_VCS_ACCOUNT: ${{ secrets.SUNTOMI_VCS_ACCOUNT }}
  SUNTOMI_VCS_ACCOUNT_EMAIL: ${{ secrets.SUNTOMI_VCS_ACCOUNT_EMAIL }}
  SUNTOMI_VCS_ACCOUNT_KEY: ${{ secrets.SUNTOMI_VCS_ACCOUNT_KEY }}
jobs:
  deplo-main:
    name: Start CI ${{ github.event.client_payload.job_id }}
    runs-on: ubuntu-latest
    outputs:
      aws: ${{ steps.deplo-main.outputs.aws }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.2.11/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.exec.revision }}
      - name: Boot deplo
        id: deplo-main
        run: deplo boot

  deplo-halt:
    name: Cleanup CI
    if: ${{ !failure() && (needs.aws.outputs.need-cleanup) }}
    needs: ["deplo-main","aws"]
    runs-on: ubuntu-latest
    env:
      DEPLO_JOB_SYSTEM_OUTPUT_AWS: ${{ needs.aws.outputs.system }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.2.11/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          lfs: false
          ref: ${{ github.event.client_payload.exec.revision }}
      - name: Halt deplo
        id: deplo-halt
        run: deplo halt

  aws:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.aws && !failure() }}
    name: Running job aws
    runs-on: ubuntu-latest
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-job-aws.outputs.need-cleanup }}
      system: ${{ steps.deplo-job-aws.outputs.system }}
      user: ${{ steps.deplo-job-aws.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.2.11/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.exec.revision }}
  
      - name: aws
        id: deplo-job-aws
        run: deplo run aws
  