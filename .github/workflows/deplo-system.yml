# generated by deplo CLI https://github.com/suntomi/deplo don't edit by hand.
name: Deplo System

on: 
  workflow_dispatch:
    inputs:
      id: # unique id
        required: true
      workflow: # key of [workflows] and integrate/deploy
        required: true
      context: # due to workflow 
        required: true
      exec: # envs, verbosity, release_target, follow_dependency
        required: true
      command: # space separated command args for deplo run sh
        required: false
      job:
        required: true
        type: choice
        options:
          - aws

env:
  DEPLO_GHACTION_CI_ID: ${{ github.run_id }}-${{ github.run_attempt }}
  DEPLO_GHACTION_EVENT_DATA: ${{ toJson(github) }}
  DEPLO_GHACTION_WORKFLOW_NAME: ${{ github.workflow }}
  DEPLO_OVERWRITE_EXEC_OPTIONS: ${{ github.event.inputs.exec }}
  DEPLO_CI_START_DEBUG_DEFAULT: ${{ vars.DEPLO_CI_START_DEBUG_DEFAULT }}
  DEPLO_CI_RUN_DEBUGGER: "true"
  SUNTOMI_VCS_ACCOUNT: ${{ secrets.SUNTOMI_VCS_ACCOUNT }}
  SUNTOMI_VCS_ACCOUNT_EMAIL: ${{ secrets.SUNTOMI_VCS_ACCOUNT_EMAIL }}
  SUNTOMI_VCS_ACCOUNT_KEY: ${{ secrets.SUNTOMI_VCS_ACCOUNT_KEY }}
jobs:
  deplo-main:
    name: Start CI ${{ github.event.inputs.id }}
    runs-on: ubuntu-latest
    outputs:
      aws: ${{ steps.deplo-main.outputs.aws }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.3.9/deplo-Linux-$(uname -m) -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Boot deplo
        id: deplo-main
        run: deplo boot
      - name: Setup ssh session to debug
        if: always() && (env.DEPLO_CI_RUN_DEBUGGER != '')
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  deplo-halt:
    name: Cleanup CI
    if: ${{ !failure() && (needs.aws.outputs.need-cleanup) }}
    needs: ["deplo-main","aws"]
    runs-on: ubuntu-latest
    env:
      DEPLO_JOB_SYSTEM_OUTPUT_AWS: ${{ needs.aws.outputs.system }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.3.9/deplo-Linux-$(uname -m) -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          lfs: false
      - name: Halt deplo
        id: deplo-halt
        run: deplo halt
      - name: Setup ssh session to debug
        if: always() && (env.DEPLO_CI_RUN_DEBUGGER != '')
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  aws:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.aws && !failure() }}
    name: Running job aws
    runs-on: ubuntu-latest
  
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-job-aws.outputs.need-cleanup }}
      system: ${{ steps.deplo-job-aws.outputs.system }}
      user: ${{ steps.deplo-job-aws.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/0.3.9/deplo-Linux-$(uname -m) -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
  
      - name: aws
        id: deplo-job-aws
        run: deplo run aws
      - name: Setup ssh session to debug
        if: always() && (env.DEPLO_CI_RUN_DEBUGGER != '')
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true